import logging
from datetime import datetime
from telegram import (
    Update,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
    InlineKeyboardButton,
    InlineKeyboardMarkup
)
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters
)

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================

BOT_TOKEN = "8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA"
CHANNEL_ID = "-1002273765519"  # ID –∫–∞–Ω–∞–ª–∞

FULL_ADMINS = [8066689541, 1157418027]
DEFAULT_ADMINS = [916852840, 7729231060]

# ================= –õ–û–ì–ò =================

logging.basicConfig(level=logging.INFO)

# ================= –•–†–ê–ù–ò–õ–ò–©–ï =================

WAITING_USERS = set()
BANNED_USERS = set()
USER_LIMIT = {}

MESSAGE_STORAGE = {}

# ================= –ö–ù–û–ü–ö–ò =================

main_keyboard = ReplyKeyboardMarkup(
    [["‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

def admin_keyboard(msg_id):
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨", callback_data=f"publish_{msg_id}"),
            InlineKeyboardButton("üî¥ –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨", callback_data=f"ignore_{msg_id}")
        ],
        [
            InlineKeyboardButton("üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨", callback_data=f"ban_{msg_id}")
        ]
    ]
    return InlineKeyboardMarkup(keyboard)

# ================= /start =================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üëá",
        reply_markup=main_keyboard
    )

# ================= –ö–ù–û–ü–ö–ò =================

async def write_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id

    if user_id in BANNED_USERS:
        return

    WAITING_USERS.add(user_id)

    await update.message.reply_text(
        "‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å –º–µ–¥–∏–∞",
        reply_markup=ReplyKeyboardRemove()
    )

async def about_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ü§ñ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç\n–û—Ç–ø—Ä–∞–≤–ª—è–π —Å–æ–æ–±—â–µ–Ω–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ.",
        reply_markup=main_keyboard
    )

# ================= –õ–ò–ú–ò–¢ =================

def check_limit(user_id):
    today = datetime.now().date()

    if user_id not in USER_LIMIT:
        USER_LIMIT[user_id] = {"date": today, "count": 0}

    if USER_LIMIT[user_id]["date"] != today:
        USER_LIMIT[user_id] = {"date": today, "count": 0}

    if USER_LIMIT[user_id]["count"] >= 5:
        return False

    USER_LIMIT[user_id]["count"] += 1
    return True

# ================= –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =================

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    msg = update.message

    if user.id in BANNED_USERS:
        return

    if user.id not in WAITING_USERS:
        return

    if not check_limit(user.id):
        await msg.reply_text("‚ö†Ô∏è –õ–∏–º–∏—Ç 5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å –∏—Å—á–µ—Ä–ø–∞–Ω.", reply_markup=main_keyboard)
        WAITING_USERS.discard(user.id)
        return

    WAITING_USERS.discard(user.id)

    name = user.first_name or "–ë–µ–∑ –∏–º–µ–Ω–∏"
    username = f"@{user.username}" if user.username else "–Ω–µ—Ç username"
    uid = user.id

    text = msg.text if msg.text else ""

    media = None
    media_type = None

    if msg.photo:
        media = msg.photo[-1].file_id
        media_type = "photo"
    elif msg.video:
        media = msg.video.file_id
        media_type = "video"
    elif msg.voice:
        media = msg.voice.file_id
        media_type = "voice"
    elif msg.video_note:
        media = msg.video_note.file_id
        media_type = "video_note"
    elif msg.audio:
        media = msg.audio.file_id
        media_type = "audio"

    msg_id = len(MESSAGE_STORAGE) + 1

    MESSAGE_STORAGE[msg_id] = {
        "text": text,
        "media": media,
        "media_type": media_type,
        "user_id": uid
    }

    # ===== FULL ADMINS =====
    for admin in FULL_ADMINS:
        caption = (
            "–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
            f"üë§ {name}\n"
            f"üîó {username}\n"
            f"üÜî {uid}\n\n"
        )
        if text:
            caption += f"üí¨ {text}"

        if media:
            await send_media(context, admin, media, media_type, caption)
        else:
            await context.bot.send_message(admin, caption)

    # ===== DEFAULT ADMINS =====
    for admin in DEFAULT_ADMINS:
        caption = "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
        if text:
            caption += f"{text}\n\n"
        caption += "@anonymousaskkbot"

        if media:
            await send_media(context, admin, media, media_type, caption, msg_id)
        else:
            await context.bot.send_message(
                admin,
                caption,
                reply_markup=admin_keyboard(msg_id)
            )

    await msg.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", reply_markup=main_keyboard)

# ================= –û–¢–ü–†–ê–í–ö–ê –ú–ï–î–ò–ê =================

async def send_media(context, chat_id, media, media_type, caption, msg_id=None):
    markup = admin_keyboard(msg_id) if msg_id else None

    if media_type == "photo":
        await context.bot.send_photo(chat_id, media, caption=caption, reply_markup=markup)
    elif media_type == "video":
        await context.bot.send_video(chat_id, media, caption=caption, reply_markup=markup)
    elif media_type == "voice":
        await context.bot.send_voice(chat_id, media, caption=caption, reply_markup=markup)
    elif media_type == "audio":
        await context.bot.send_audio(chat_id, media, caption=caption, reply_markup=markup)
    elif media_type == "video_note":
        await context.bot.send_video_note(chat_id, media)
        await context.bot.send_message(chat_id, caption, reply_markup=markup)

# ================= INLINE –ö–ù–û–ü–ö–ò =================

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    action, msg_id = query.data.split("_")
    msg_id = int(msg_id)

    data = MESSAGE_STORAGE.get(msg_id)
    if not data:
        return

    text = data["text"]
    media = data["media"]
    media_type = data["media_type"]
    user_id = data["user_id"]

    caption = "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
    if text:
        caption += f"{text}\n\n"
    caption += "@anonymousaskkbot"

    if action == "publish":
        if media:
            await send_media(context, CHANNEL_ID, media, media_type, caption)
        else:
            await context.bot.send_message(CHANNEL_ID, caption)

        await query.edit_message_reply_markup(None)
        await query.message.reply_text("‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ")

    elif action == "ignore":
        await query.edit_message_reply_markup(None)
        await query.message.reply_text("üî¥ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ")

    elif action == "ban":
        BANNED_USERS.add(user_id)
        await query.edit_message_reply_markup(None)
        await query.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")

# ================= –ó–ê–ü–£–°–ö =================

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("^‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ$"), write_message))
    app.add_handler(MessageHandler(filters.Regex("^‚ÑπÔ∏è –û –±–æ—Ç–µ$"), about_bot))
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))
    app.add_handler(CallbackQueryHandler(button_handler))

    app.run_polling()

if __name__ == "__main__":
    main()
