import os
from datetime import datetime, timedelta
from telegram import Update, ReplyKeyboardMarkup, InputMediaPhoto, InputMediaVideo
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =========================
BOT_TOKEN = os.environ.get("BOT_TOKEN")
FULL_ADMINS = list(map(int, os.environ.get("FULL_ADMINS").split(",")))   # –ø–æ–ª–Ω—ã–µ –∞–¥–º–∏–Ω—ã
DEFAULT_ADMINS = list(map(int, os.environ.get("DEFAULT_ADMINS").split(",")))  # –ø–µ—Ä–µ—Å—ã–ª–∫–∞
MESSAGE_LIMIT = 5

LAST_MESSAGE = {}
BANNED_USERS = set()
USER_COUNTER = {}  # {user_id: {"count": int, "date": datetime}}

# =========================
# –ö–Ω–æ–ø–∫–∏
# =========================
main_keyboard = ReplyKeyboardMarkup([["‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]], resize_keyboard=True)

# =========================
# /start
# =========================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return
    await update.message.reply_text("üëã –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É.", reply_markup=main_keyboard)

# =========================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
# =========================
def check_limit(user_id):
    now = datetime.now()
    data = USER_COUNTER.get(user_id)
    if not data or data["date"].date() != now.date():
        USER_COUNTER[user_id] = {"count": 0, "date": now}
    return USER_COUNTER[user_id]["count"] < MESSAGE_LIMIT

def increment_count(user_id):
    USER_COUNTER[user_id]["count"] += 1

# =========================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
# =========================
def is_full_admin(user_id): return user_id in FULL_ADMINS
def is_default_admin(user_id): return user_id in DEFAULT_ADMINS

# =========================
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤
# =========================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    # –õ–∏–º–∏—Ç
    if not check_limit(user_id):
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç {MESSAGE_LIMIT} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.")
        return
    increment_count(user_id)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    LAST_MESSAGE["user"] = user
    LAST_MESSAGE["message"] = update.message

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω—É
    admin_text = (
        "üéâüéâüéâ –ù–û–í–û–ï –ê–ù–û–ù–ò–ú–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï!\n"
        "üì¨ –ö—Ç–æ-—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –±–æ—Ç—É\n"
        "üî• –°–º–æ—Ç—Ä–∏ –Ω–∏–∂–µ ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è"
    )

    for admin_id in FULL_ADMINS + DEFAULT_ADMINS:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        await context.bot.send_message(chat_id=admin_id, text=admin_text)

        # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        if update.message.text:
            await context.bot.send_message(chat_id=admin_id, text=update.message.text)
        elif update.message.photo:
            await context.bot.send_photo(chat_id=admin_id, photo=update.message.photo[-1].file_id)
        elif update.message.video:
            await context.bot.send_video(chat_id=admin_id, video=update.message.video.file_id)
        elif update.message.audio:
            await context.bot.send_audio(chat_id=admin_id, audio=update.message.audio.file_id)
        elif update.message.voice:await context.bot.send_voice(chat_id=admin_id, voice=update.message.voice.file_id)
        elif update.message.document:
            await context.bot.send_document(chat_id=admin_id, document=update.message.document.file_id)

    await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.", reply_markup=main_keyboard)

# =========================
# –ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã —Å–∫—Ä—ã—Ç—ã–µ
# =========================
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_full_admin(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id>")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.add(uid)
        await update.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_full_admin(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.discard(uid)
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

# =========================
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# =========================
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # –ö–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("ban", ban))
    app.add_handler(CommandHandler("unban", unban))

    # –°–æ–æ–±—â–µ–Ω–∏—è –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
