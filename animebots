import os
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, InputMediaPhoto, InputMediaVideo
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, CommandHandler, filters

# =================== –ù–ê–°–¢–†–û–ô–ö–ò ===================
BOT_TOKEN = "8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA"

FULL_ADMINS = [8066689541,1157418027]       # –ü–æ–ª–Ω—ã–µ –∞–¥–º–∏–Ω—ã (–≤–∏–¥—è—Ç –≤—Å—ë, ID –∫–∞–∫ int)
DEFAULT_ADMINS = [916852840,7729231060]    # –î–µ—Ñ–æ–ª—Ç –∞–¥–º–∏–Ω—ã (–ø–µ—Ä–µ—Å—ã–ª–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è)
BANNED_USERS = set()            # –ó–∞–±–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
LIMIT_MESSAGES_PER_DAY = 5

user_messages_count = {}        # –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∫–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å
WAITING_MESSAGE = 1             # —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

# =================== –ö–õ–ê–í–ò–ê–¢–£–†–ê ===================
main_keyboard = ReplyKeyboardMarkup(
    [["‚úç –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚Ñπ –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

# =================== –•–ï–õ–ü–ï–†–´ ===================
def is_banned(user_id: int):
    return user_id in BANNED_USERS

def make_admin_caption(user, text, media_type=None):
    """–°–æ–∑–¥–∞—ë—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –∞–¥–º–∏–Ω–æ–≤"""
    username = f"@{user.username}" if user.username else "–Ω–µ—Ç username"
    msg = f"–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
    msg += f"üë§ –ò–º—è: {user.first_name}\n"
    msg += f"üîó Username: {username}\n"
    msg += f"üÜî ID: {user.id}\n"
    if media_type:
        msg += f"üìé {media_type}\n"
    msg += f"\nüí¨ –¢–µ–∫—Å—Ç:\n{text}"
    return msg

# =================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ===================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –∞–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=main_keyboard
    )

async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ü§ñ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç\n"
        "–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∞–Ω–æ–Ω–∏–º–Ω–æ.\n"
        "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏—Ö —É–≤–∏–¥–∏—Ç, –Ω–æ –≤—ã –æ—Å—Ç–∞–Ω–µ—Ç–µ—Å—å –∞–Ω–æ–Ω–∏–º–Ω—ã–º–∏.",
        reply_markup=main_keyboard
    )

async def start_write(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if is_banned(user_id):
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.")
        return
    if user_messages_count.get(user_id, 0) >= LIMIT_MESSAGES_PER_DAY:
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å ({LIMIT_MESSAGES_PER_DAY}) –∏—Å—á–µ—Ä–ø–∞–Ω.")
        return
    context.user_data["state"] = WAITING_MESSAGE
    await update.message.reply_text("‚úç –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ:", reply_markup=ReplyKeyboardRemove())

async def handle_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    state = context.user_data.get("state")

    if state != WAITING_MESSAGE:
        # –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        text = update.message.text
        if text == "‚úç –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ":
            await start_write(update, context)
        elif text == "‚Ñπ –û –±–æ—Ç–µ":
            await about(update, context)
        return

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if is_banned(user.id):
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.")
        context.user_data["state"] = None
        return

    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    count = user_messages_count.get(user.id, 0)
    if count >= LIMIT_MESSAGES_PER_DAY:
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å ({LIMIT_MESSAGES_PER_DAY}) –∏—Å—á–µ—Ä–ø–∞–Ω.")
        context.user_data["state"] = None
        return

    # –ø–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ–¥–∏–∞
    user_message_text = update.message.text or ""
    media_type = None
    media_file_id = None

    if update.message.photo:
        media_type = "–§–æ—Ç–æ"
        media_file_id = update.message.photo[-1].file_id
    elif update.message.video:
        media_type = "–í–∏–¥–µ–æ"
        media_file_id = update.message.video.file_id
    elif update.message.voice:
        media_type = "–ì–æ–ª–æ—Å–æ–≤–æ–µ"
        media_file_id = update.message.voice.file_id
    elif update.message.audio:
        media_type = "–ê—É–¥–∏–æ"
        media_file_id = update.message.audio.file_id
    elif update.message.document:
        media_type = "–§–∞–π–ª"
media_file_id = update.message.document.file_id

    # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º
    
all_admins = FULL_ADMINS + DEFAULT_ADMINS
   
for admin_id in all_admins:
        if admin_id in FULL_ADMINS:
            # –ø–æ–ª–Ω—ã–π –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç –∏–º—è, username –∏ –Ω–æ–º–µ—Ä
            caption = make_admin_caption(user, user_message_text, media_type)
        else:
            # –¥–µ—Ñ–æ–ª—Ç –∞–¥–º–∏–Ω –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —Ç–∏–ø –º–µ–¥–∏–∞
            caption = f"üéâ –ù–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n"
            if media_type:
                caption += f"üìé {media_type}\n"
            if user_message_text:
                caption += f"{user_message_text}"

        if media_file_id:
            if media_type == "–§–æ—Ç–æ":
                await context.bot.send_photo(admin_id, media_file_id, caption=caption)
            elif media_type == "–í–∏–¥–µ–æ":
                await context.bot.send_video(admin_id, media_file_id, caption=caption)
            elif media_type == "–ì–æ–ª–æ—Å–æ–≤–æ–µ":
                await context.bot.send_voice(admin_id, media_file_id, caption=caption)
            elif media_type == "–ê—É–¥–∏–æ":
                await context.bot.send_audio(admin_id, media_file_id, caption=caption)
            elif media_type == "–§–∞–π–ª":
                await context.bot.send_document(admin_id, media_file_id, caption=caption)
        else:
            await context.bot.send_message(admin_id, caption)

    # —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    
await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ", reply_markup=main_keyboard)

    # —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    user_messages_count[user.id] = count + 1
    context.user_data["state"] = None

# =================== –ö–û–ú–ê–ù–î–´ –ê–î–ú–ò–ù–ê ===================
async def ban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = int(context.args[0])
    BANNED_USERS.add(user_id)
    await update.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–∞–Ω–µ–Ω.")

async def unban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = int(context.args[0])
    BANNED_USERS.discard(user_id)
    await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–∞–∑–±–∞–Ω–µ–Ω.")

# =================== –ó–ê–ü–£–°–ö ===================
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.Regex("^‚úç –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ$"), start_write))
    app.add_handler(MessageHandler(filters.Regex("^‚Ñπ –û –±–æ—Ç–µ$"), about))
    app.add_handler(MessageHandler(filters.ALL, handle_user_message))

    app.add_handler(CommandHandler("ban", ban_user))
    app.add_handler(CommandHandler("unban", unban_user))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
