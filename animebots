import os
from datetime import datetime
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, filters, CommandHandler

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
BOT_TOKEN = "8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA"

FULL_ADMINS = [8066689541,1157418027]  # –ø–æ–ª–Ω—ã–µ –∞–¥–º–∏–Ω—ã (–≤–∏–¥—è—Ç –≤—Å–µ—Ö, —é–∑–µ—Ä–Ω–µ–π–º, –Ω–æ–º–µ—Ä)
DEFAULT_ADMINS = [916852840,7729231060]  # –æ–±—ã—á–Ω—ã–µ –∞–¥–º–∏–Ω—ã (–ø–µ—Ä–µ—Å—ã–ª–∞—é—Ç —Å–æ–æ–±—â–µ–Ω–∏—è)
ALL_ADMINS = FULL_ADMINS + DEFAULT_ADMINS

DAILY_LIMIT = 5  # –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å

# –°–æ—Å—Ç–æ—è–Ω–∏—è
WAITING_MESSAGE = "waiting_message"

# –ë–∞–Ω-–ª–∏—Å—Ç
banned_users = set()

# –°—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
user_message_count = {}

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
main_keyboard = ReplyKeyboardMarkup([
    [KeyboardButton("‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")],
    [KeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ")]
], resize_keyboard=True)

# === –•–µ–Ω–¥–ª–µ—Ä—ã ===

async def start_write(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in banned_users:
        await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.")
        return
    context.user_data["state"] = WAITING_MESSAGE
    await update.message.reply_text("‚úçÔ∏è –ü–∏—à–∏ —Å–≤–æ—ë —Å–æ–æ–±—â–µ–Ω–∏–µ:", reply_markup=main_keyboard)

async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("‚ÑπÔ∏è –≠—Ç–æ –∞–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π.\n@anonymousaskkbot", reply_markup=main_keyboard)

async def handle_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    if user_id in banned_users:
        await update.message.reply_text("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.")
        return

    state = context.user_data.get("state")
    if state != WAITING_MESSAGE:
        return  # –Ω–µ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞

    # –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
    count = user_message_count.get(user_id, 0)
    if count >= DAILY_LIMIT:
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç {DAILY_LIMIT} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å –∏—Å—á–µ—Ä–ø–∞–Ω.")
        return
    user_message_count[user_id] = count + 1

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è
    media_type = "–¢–µ–∫—Å—Ç"
    media_file_id = None
    if update.message.photo:
        media_type = "–§–æ—Ç–æ"
        media_file_id = update.message.photo[-1].file_id
    elif update.message.video:
        media_type = "–í–∏–¥–µ–æ"
        media_file_id = update.message.video.file_id
    elif update.message.voice:
        media_type = "–ì–æ–ª–æ—Å–æ–≤–æ–µ"
        media_file_id = update.message.voice.file_id
    elif update.message.audio:
        media_type = "–ê—É–¥–∏–æ"
        media_file_id = update.message.audio.file_id
    elif update.message.document:
        media_type = "–§–∞–π–ª"
        media_file_id = update.message.document.file_id

    # –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    user_message_text = update.message.text or f"({media_type})"

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –∞–¥–º–∏–Ω—É
    for admin_id in ALL_ADMINS:
        if admin_id in FULL_ADMINS:
            caption = f"–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\nüë§ {user.first_name}\nüÜî {user.id}\nüí¨ {user_message_text}"
        else:
            caption = f"üéâüéâüéâ –ù–û–í–û–ï –ê–ù–û–ù–ò–ú–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï!\nüì¨ –ö—Ç–æ-—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –±–æ—Ç—É:\nüí¨ {user_message_text}"

        if media_file_id:
            if media_type in ["–§–æ—Ç–æ"]:
                await context.bot.send_photo(chat_id=admin_id, photo=media_file_id, caption=caption)
            elif media_type in ["–í–∏–¥–µ–æ"]:
                await context.bot.send_video(chat_id=admin_id, video=media_file_id, caption=caption)
            elif media_type in ["–ì–æ–ª–æ—Å–æ–≤–æ–µ"]:
                await context.bot.send_voice(chat_id=admin_id, voice=media_file_id, caption=caption)
            elif media_type in ["–ê—É–¥–∏–æ"]:
                await context.bot.send_audio(chat_id=admin_id, audio=media_file_id, caption=caption)
            else:
                 await context.bot.send_message(chat_id=admin_id, text=caption)
        else:
            await context.bot.send_message(chat_id=admin_id, text=caption)

    # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ.", reply_markup=main_keyboard)
    context.user_data["state"] = None

# === –ë–∞–Ω –∫–æ–º–∞–Ω–¥–∞ ===
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = int(context.args[0])
    banned_users.add(user_id)
    await update.message.reply_text(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–∞–Ω–µ–Ω.")

# === –†–∞–∑–±–∞–Ω –∫–æ–º–∞–Ω–¥–∞ ===
async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = int(context.args[0])
    banned_users.discard(user_id)
    await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–∞–∑–±–∞–Ω–µ–Ω.")

# === –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # –ö–Ω–æ–ø–∫–∏
    app.add_handler(MessageHandler(filters.Regex("‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"), start_write))
    app.add_handler(MessageHandler(filters.Regex("‚ÑπÔ∏è –û –±–æ—Ç–µ"), about))

    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_user_message))

    # –ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("ban", ban))
    app.add_handler(CommandHandler("unban", unban))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
