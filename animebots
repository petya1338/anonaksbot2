import os
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, ContextTypes, MessageHandler, CommandHandler, filters

# ===== –ù–ê–°–¢–†–û–ô–ö–ò =====
BOT_TOKEN = "PASTE_YOUR_BOT_TOKEN_HERE"

# ID –∞–¥–º–∏–Ω–æ–≤
FULL_ADMINS = [123456789]     # –ü–æ–ª–Ω—ã–µ –∞–¥–º–∏–Ω—ã (–≤–∏–¥—è—Ç –≤—Å–µ, —Å —é–∑–µ—Ä–Ω–µ–π–º–æ–º –∏ –Ω–æ–º–µ—Ä–æ–º)
DEFAULT_ADMINS = [987654321]  # –î–µ—Ñ–æ–ª—Ç –∞–¥–º–∏–Ω—ã (–≤–∏–¥—è—Ç –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

# –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å
LIMIT_MESSAGES_PER_DAY = 5

# –°–æ—Å—Ç–æ—è–Ω–∏—è
WAITING_MESSAGE = "waiting_message"

# –•—Ä–∞–Ω–∏–ª–∏—â–∞
user_messages_count = {}
banned_users = set()

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
main_keyboard = ReplyKeyboardMarkup(
    [["‚úç –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ", "‚Ñπ –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

# ======== –§–£–ù–ö–¶–ò–ò ========
def is_banned(user_id):
    return user_id in banned_users

def make_admin_caption(user, text, media_type=None):
    caption = f"–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
    caption += f"–ò–º—è: {user.first_name}\n"
    caption += f"Username: @{user.username if user.username else '–Ω–µ—Ç'}\n"
    caption += f"ID: {user.id}\n\n"
    if media_type:
        caption += f"üìé {media_type}\n"
    if text:
        caption += f"{text}"
    return caption

# ======== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ========
async def start_write(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["state"] = WAITING_MESSAGE
    await update.message.reply_text("‚úç –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ–Ω–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ!")

async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("ü§ñ –≠—Ç–æ—Ç –±–æ—Ç –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–æ–Ω–∏–º–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º.")

async def handle_user_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    state = context.user_data.get("state")

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–Ω–æ–ø–∫—É
    if state != WAITING_MESSAGE:
        text = update.message.text
        if text == "‚úç –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ":
            await start_write(update, context)
        elif text == "‚Ñπ –û –±–æ—Ç–µ":
            await about(update, context)
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if is_banned(user.id):
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–∞–Ω–µ–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è.")
        context.user_data["state"] = None
        return

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
    count = user_messages_count.get(user.id, 0)
    if count >= LIMIT_MESSAGES_PER_DAY:
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å ({LIMIT_MESSAGES_PER_DAY}) –∏—Å—á–µ—Ä–ø–∞–Ω.")
        context.user_data["state"] = None
        return

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ–¥–∏–∞
    user_message_text = update.message.text or ""
    media_type = None
    media_file_id = None

    if update.message.photo:
        media_type = "–§–æ—Ç–æ"
        media_file_id = update.message.photo[-1].file_id
    elif update.message.video:
        media_type = "–í–∏–¥–µ–æ"
        media_file_id = update.message.video.file_id
    elif update.message.voice:
        media_type = "–ì–æ–ª–æ—Å–æ–≤–æ–µ"
        media_file_id = update.message.voice.file_id
    elif update.message.audio:
        media_type = "–ê—É–¥–∏–æ"
        media_file_id = update.message.audio.file_id
    elif update.message.document:
        media_type = "–§–∞–π–ª"
        media_file_id = update.message.document.file_id

    # ===== –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–º –∞–¥–º–∏–Ω–∞–º =====
    all_admins = FULL_ADMINS + DEFAULT_ADMINS
    for admin_id in all_admins:
        if admin_id in FULL_ADMINS:
            caption = make_admin_caption(user, user_message_text, media_type)
        else:
            caption = f"–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n"
            if media_type:
                caption += f"üìé {media_type}\n"
            if user_message_text:
                caption += f"{user_message_text}\n"
            caption += "\n@anonymousaskkbot"

        if media_file_id:
            if media_type == "–§–æ—Ç–æ":
                await context.bot.send_photo(admin_id, media_file_id, caption=caption)
            elif media_type == "–í–∏–¥–µ–æ":
                await context.bot.send_video(admin_id, media_file_id, caption=caption)
            elif media_type == "–ì–æ–ª–æ—Å–æ–≤–æ–µ":
                await context.bot.send_voice(admin_id, media_file_id, caption=caption)
            elif media_type == "–ê—É–¥–∏–æ":
                await context.bot.send_audio(admin_id, media_file_id, caption=caption)
            elif media_type == "–§–∞–π–ª":
                await context.bot.send_document(admin_id, media_file_id, caption=caption)
        else:
            await context.bot.send_message(admin_id, caption)

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text(
        "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ",
        reply_markup=main_keyboard
    )

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    user_messages_count[user.id] = count + 1
    context.user_data["state"] = None

# ======== –ö–û–ú–ê–ù–î–´ –ê–î–ú–ò–ù–ê ========
async def ban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    try:
        user_id = int(context.args[0])
        banned_users.add(user_id)
        await update.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∑–∞–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id>")

async def unban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    try:
        user_id = int(context.args[0])
        banned_users.discard(user_id)
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} —Ä–∞–∑–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>")

# ======== –ó–ê–ü–£–°–ö ========
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_user_message))
    app.add_handler(CommandHandler("ban", ban_user))
    app.add_handler(CommandHandler("unban", unban_user))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
