import os
from datetime import datetime
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =========================
BOT_TOKEN = os.environ.get("BOT_TOKEN")
FULL_ADMINS = list(map(int, os.environ.get("FULL_ADMINS", "0").split(",")))
DEFAULT_ADMINS = list(map(int, os.environ.get("DEFAULT_ADMINS", "0").split(",")))
MESSAGE_LIMIT = 5

LAST_MESSAGE = {}
BANNED_USERS = set()
USER_COUNTER = {}  # {user_id: {"count": int, "date": datetime}}

# =========================
# –ö–Ω–æ–ø–∫–∏
# =========================
main_keyboard = ReplyKeyboardMarkup([["‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]], resize_keyboard=True)

# =========================
# /start
# =========================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return
    await update.message.reply_text("üëã –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É.", reply_markup=main_keyboard)

# =========================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
# =========================
def check_limit(user_id):
    now = datetime.now()
    data = USER_COUNTER.get(user_id)
    if not data or data["date"].date() != now.date():
        USER_COUNTER[user_id] = {"count": 0, "date": now}
    return USER_COUNTER[user_id]["count"] < MESSAGE_LIMIT

def increment_count(user_id):
    USER_COUNTER[user_id]["count"] += 1

# =========================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
# =========================
def is_full_admin(user_id): return user_id in FULL_ADMINS
def is_default_admin(user_id): return user_id in DEFAULT_ADMINS

# =========================
# –§–æ—Ä–º–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
# =========================
def make_admin_text(user, message):
    phone = user.phone_number if hasattr(user, 'phone_number') and user.phone_number else "–Ω–µ—Ç"
    return (
        f"üì© –ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
        f"üë§ –ò–º—è: {user.first_name}\n"
        f"üîó Username: @{user.username if user.username else '–Ω–µ—Ç'}\n"
        f"üÜî ID: {user.id}\n"
        f"üìû –ù–æ–º–µ—Ä: {phone}\n\n"
        f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:\n\"{message}\""
    )

def make_default_admin_text(message):
    return (
        f"üéâüéâüéâ –ù–û–í–û–ï –ê–ù–û–ù–ò–ú–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï!\n"
        f"üì¨ –ö—Ç–æ-—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª –±–æ—Ç—É\n"
        f"üî• –°–º–æ—Ç—Ä–∏ –Ω–∏–∂–µ ‚¨áÔ∏è‚¨áÔ∏è‚¨áÔ∏è\n\n"
        f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:\n\"{message}\""
    )

# =========================
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤
# =========================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    # –õ–∏–º–∏—Ç
    if not check_limit(user_id):
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç {MESSAGE_LIMIT} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.")
        return
    increment_count(user_id)

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    LAST_MESSAGE["user"] = user
    LAST_MESSAGE["message"] = update.message

    # –¢–µ–∫—Å—Ç –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
    if update.message.text:
        user_message = update.message.text
    elif update.message.photo:
        user_message = "[–§–æ—Ç–æ]"
    elif update.message.video:
        user_message = "[–í–∏–¥–µ–æ]"
    elif update.message.audio:
        user_message = "[–ê—É–¥–∏–æ]"
    elif update.message.voice:
        user_message = "[–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ]"
    elif update.message.document:
        user_message = "[–î–æ–∫—É–º–µ–Ω—Ç]"
    else:
        user_message = "[–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è]"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Full Admin
    full_text = make_admin_text(user, user_message)
    for admin_id in FULL_ADMINS:
        await context.bot.send_message(chat_id=admin_id, text=full_text)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Default Admin
    default_text = make_default_admin_text(user_message)
    for admin_id in DEFAULT_ADMINS:
        await context.bot.send_message(chat_id=admin_id, text=default_text)

    # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.", reply_markup=main_keyboard)

# =========================
# –°–∫—Ä—ã—Ç—ã–µ –∞–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã
# =========================
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_full_admin(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id>")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.add(uid)
        await update.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_full_admin(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.discard(uid)
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

# =========================
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# =========================
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # –ö–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("ban", ban))
    app.add_handler(CommandHandler("unban", unban))

    # –°–æ–æ–±—â–µ–Ω–∏—è –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
