from telegram import (
    Update,
    ReplyKeyboardMarkup,
    KeyboardButton
)
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    MessageHandler,
    CommandHandler,
    filters
)
import datetime

# ========= –ù–ê–°–¢–†–û–ô–ö–ò =========
BOT_TOKEN = "8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA"

FULL_ADMINS = [8066689541,1157418027]       # üëë full –∞–¥–º–∏–Ω—ã
DEFAULT_ADMINS = [916852840,7729231060]    # üëÆ –æ–±—ã—á–Ω—ã–µ –∞–¥–º–∏–Ω—ã
ALL_ADMINS = FULL_ADMINS + DEFAULT_ADMINS

DAILY_LIMIT = 5

# ========= –°–û–°–¢–û–Ø–ù–ò–Ø =========
WAITING_MESSAGE = "waiting_message"
user_state = {}
user_daily_count = {}
banned_users = set()

# ========= –ö–ù–û–ü–ö–ò =========
main_keyboard = ReplyKeyboardMarkup(
    [
        [KeyboardButton("‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ")],
        [KeyboardButton("‚ÑπÔ∏è –û –±–æ—Ç–µ")]
    ],
    resize_keyboard=True
)

# ========= –•–ï–ù–î–õ–ï–†–´ =========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "üëã –ù–∞–ø–∏—à–∏ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ",
        reply_markup=main_keyboard
    )


async def write_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    if uid in banned_users:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    user_state[uid] = WAITING_MESSAGE
    await update.message.reply_text("‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ:")


async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "‚ÑπÔ∏è –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π\n@anonymousaskkbot",
        reply_markup=main_keyboard
    )


def check_limit(uid: int) -> bool:
    today = datetime.date.today()
    if uid not in user_daily_count:
        user_daily_count[uid] = {"date": today, "count": 0}

    if user_daily_count[uid]["date"] != today:
        user_daily_count[uid] = {"date": today, "count": 0}

    if user_daily_count[uid]["count"] >= DAILY_LIMIT:
        return False

    user_daily_count[uid]["count"] += 1
    return True


async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    uid = user.id

    if uid in banned_users:
        return

    if user_state.get(uid) != WAITING_MESSAGE:
        return

    if not check_limit(uid):
        await update.message.reply_text("‚ö†Ô∏è –õ–∏–º–∏—Ç 5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å.")
        return

    user_state[uid] = None

    text = update.message.text or ""

    for admin in ALL_ADMINS:
        if admin in FULL_ADMINS:
            caption = (
                f"–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
                f"üë§ {user.first_name}\n"
                f"üîó {username}\n"
                f"üÜî {uid}\n"
            )
            if text:
                caption += f"üí¨ {text}"
        else:
            caption = (
                "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
            )
            if text:
                caption += f"{text}\n\n"
            caption += "@anonymousaskkbot"

        # ===== –ú–ï–î–ò–ê =====
        if update.message.photo:
            await context.bot.send_photo(
                admin,
                update.message.photo[-1].file_id,
                caption=caption
            )
        elif update.message.video:
            await context.bot.send_video(
                admin,
                update.message.video.file_id,
                caption=caption
            )
        elif update.message.voice:
            await context.bot.send_voice(
                admin,
                update.message.voice.file_id,
                caption=caption
            )
        elif update.message.audio:
            await context.bot.send_audio(
                admin,
                update.message.audio.file_id,
                caption=caption
            )
        elif update.message.video_note:
            await context.bot.send_video_note(
                admin,
                update.message.video_note.file_id
            )
            await context.bot.send_message(admin, caption)
        else:
            await context.bot.send_message(admin, caption)

    await update.message.reply_text(
        "‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ",
        reply_markup=main_keyboard
    )


# ========= –ê–î–ú–ò–ù –ö–û–ú–ê–ù–î–´ =========
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π: /ban ID")
        return

    banned_users.add(int(context.args[0]))
    await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω")


async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π: /unban ID")
        return

    banned_users.discard(int(context.args[0]))
    await update.message.reply_text("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–∞–Ω–µ–Ω")


# ========= –ó–ê–ü–£–°–ö =========
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("ban", ban))
    app.add_handler(CommandHandler("unban", unban))

    app.add_handler(MessageHandler(filters.Regex("^‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ$"), write_message))
    app.add_handler(MessageHandler(filters.Regex("^‚ÑπÔ∏è –û –±–æ—Ç–µ$"), about))

    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()


if __name__ == "__main__":
    main()
