import logging
from telegram import (
    Update,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    InputMediaPhoto,
    InputMediaVideo
)
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters
)

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================

BOT_TOKEN = "8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA"
CHANNEL_ID = "-1002273765519"  # –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

FULL_ADMINS = [8066689541, 1157418027]        # –ø–æ–ª–Ω—ã–µ –∞–¥–º–∏–Ω—ã
DEFAULT_ADMINS = [916852840, 7729231060]     # –æ–±—ã—á–Ω—ã–µ –∞–¥–º–∏–Ω—ã

MAX_MESSAGES_PER_DAY = 5

# ================= –õ–û–ì–ò =================

logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)

# ================= –•–†–ê–ù–ò–õ–ò–©–ê =================

WAITING_USERS = set()
BANNED_USERS = set()
from datetime import date

USER_MESSAGE_COUNT = {}  # user_id: {"date": date, "count": int}
PENDING_MESSAGES = {}  # message_id: dict —Å info –¥–ª—è callback

# ================= –ö–ù–û–ü–ö–ò =================

main_keyboard = ReplyKeyboardMarkup(
    [["‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

# ================= /start =================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üëá",
        reply_markup=main_keyboard
    )

# ================= –ù–ê–ü–ò–°–ê–¢–¨ =================

async def write_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    # –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
    today = date.today()

user_data = USER_MESSAGE_COUNT.get(user_id)

if user_data:
    if user_data["date"] == today and user_data["count"] >= MAX_MESSAGES_PER_DAY:
        await update.message.reply_text("‚ö†Ô∏è –õ–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω.")
        return

    WAITING_USERS.add(user_id)
    await update.message.reply_text(
        "‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å –º–µ–¥–∏–∞",
        reply_markup=ReplyKeyboardRemove()
    )

# ================= –û –ë–û–¢–ï =================

async def about_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ü§ñ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π\n\n"
        "–¢—ã –º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ –º–µ–¥–∏–∞ –∞–Ω–æ–Ω–∏–º–Ω–æ.",
        reply_markup=main_keyboard
    )

# ================= –ë–ê–ù =================

async def ban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    if not context.args:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /ban ID")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.add(uid)
        await update.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω")
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

# ================= –ê–ù–ë–ê–ù =================

async def unban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    if not context.args:
        await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /unban ID")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.discard(uid)
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω")
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

# ================= –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =================

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    msg = update.message

    if user.id in BANNED_USERS:
        return
    if user.id not in WAITING_USERS:
        return

    WAITING_USERS.remove(user.id)
    USER_MESSAGE_COUNT[user.id] = USER_MESSAGE_COUNT.get(user.id, 0) + 1

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –º–µ–¥–∏–∞
    text = msg.text or ""
    media_file_id = None
    media_type = None

    if msg.photo:
        media_file_id = msg.photo[-1].file_id
        media_type = "photo"
    elif msg.video:
        media_file_id = msg.video.file_id
        media_type = "video"
    elif msg.voice:
        media_file_id = msg.voice.file_id
        media_type = "voice"
    elif msg.audio:
        media_file_id = msg.audio.file_id
        media_type = "audio"
    elif msg.video_note:
        media_file_id = msg.video_note.file_id
        media_type = "video_note"

    # ==== FULL ADMINS ====
    for admin_id in FULL_ADMINS:
        username = f"@{user.username}" if user.username else "–Ω–µ—Ç username"
        caption = f"–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\nüë§ {user.first_name}\nüîó {username}\nüÜî {user.id}"
        if text:
            caption += f"\nüí¨ {text}"

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –º–µ–¥–∏–∞
        if media_file_id:
            if media_type == "photo":
                await context.bot.send_photo(admin_id, media_file_id, caption=caption)
            elif media_type == "video":
                await context.bot.send_video(admin_id, media_file_id, caption=caption)
            elif media_type == "voice":
                await context.bot.send_voice(admin_id, media_file_id, caption=caption)
            elif media_type == "audio":
                await context.bot.send_audio(admin_id, media_file_id, caption=caption)
            elif media_type == "video_note":
                await context.bot.send_video_note(admin_id, media_file_id)
                await context.bot.send_message(admin_id, caption)
        else:
            await context.bot.send_message(admin_id, caption)

    # ==== DEFAULT ADMINS ====
    for admin_id in DEFAULT_ADMINS:
        caption = "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
        if text:
            caption += f"{text}\n\n"
        caption += "@anonymousaskkbot"

        # Inline –∫–Ω–æ–ø–∫–∏
        buttons = InlineKeyboardMarkup([
            [
                InlineKeyboardButton("‚úÖ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨", callback_data="publish"),
                InlineKeyboardButton("üî¥ –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨", callback_data="ignore"),
                InlineKeyboardButton("üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨", callback_data=f"ban:{user.id}")
            ]
        ])

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞ —Å –ø–æ–¥–ø–∏—Å—å—é
        if media_file_id:
            if media_type == "photo":
                sent_msg = await context.bot.send_photo(admin_id, media_file_id, caption=caption, reply_markup=buttons)
            elif media_type == "video":
                sent_msg = await context.bot.send_video(admin_id, media_file_id, caption=caption, reply_markup=buttons)
            elif media_type == "voice":
                sent_msg = await context.bot.send_voice(admin_id, media_file_id, caption=caption, reply_markup=buttons)
            elif media_type == "audio":
                sent_msg = await context.bot.send_audio(admin_id, media_file_id, caption=caption, reply_markup=buttons)
            elif media_type == "video_note":
                sent_msg = await context.bot.send_video_note(admin_id, media_file_id, reply_markup=buttons)
                await context.bot.send_message(admin_id, caption)
        else:
            sent_msg = await context.bot.send_message(admin_id, caption, reply_markup=buttons)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è callback
        PENDING_MESSAGES[sent_msg.message_id] = {
            "text": text,
            "media_file_id": media_file_id,
            "media_type": media_type,
            "user_id": user.id
        }

    await msg.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–Ω–æ–Ω–∏–º–Ω–æ", reply_markup=main_keyboard)

# ================= CALLBACK =================

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    data = query.data
    msg_id = query.message.message_id

    if msg_id not in PENDING_MESSAGES:
        await query.message.edit_reply_markup(None)
        return

    info = PENDING_MESSAGES[msg_id]
    text = info["text"]
    media_file_id = info["media_file_id"]
    media_type = info["media_type"]
    user_id = info["user_id"]

    if data == "publish":
        caption = "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
        if text:
            caption += f"{text}\n\n"
        caption += "@anonymousaskkbot"

        # –ü—É–±–ª–∏–∫—É–µ–º –≤ –∫–∞–Ω–∞–ª
        if media_file_id:
            if media_type == "photo":
                await context.bot.send_photo(CHANNEL_ID, media_file_id, caption=caption)
            elif media_type == "video":
                await context.bot.send_video(CHANNEL_ID, media_file_id, caption=caption)
            elif media_type == "voice":
                await context.bot.send_voice(CHANNEL_ID, media_file_id, caption=caption)
            elif media_type == "audio":
                await context.bot.send_audio(CHANNEL_ID, media_file_id, caption=caption)
            elif media_type == "video_note":
                await context.bot.send_video_note(CHANNEL_ID, media_file_id)
                await context.bot.send_message(CHANNEL_ID, caption)
        else:
            await context.bot.send_message(CHANNEL_ID, caption)

        await query.message.edit_reply_markup(None)
        await query.message.reply_text("‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ")

    elif data == "ignore":
        await query.message.edit_reply_markup(None)
        await query.message.reply_text("üî¥ –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ")

    elif data.startswith("ban:"):
        try:
            uid = int(data.split(":")[1])
            BANNED_USERS.add(uid)
            await query.message.edit_reply_markup(None)
            await query.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω")
        except:
            pass

# ================= –ó–ê–ü–£–°–ö =================

def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("ban", ban_user))
    app.add_handler(CommandHandler("unban", unban_user))

    app.add_handler(MessageHandler(filters.Regex("^‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ$"), write_message))
    app.add_handler(MessageHandler(filters.Regex("^‚ÑπÔ∏è –û –±–æ—Ç–µ$"), about_bot))
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))
    app.add_handler(CallbackQueryHandler(button_handler))

    app.run_polling()

if __name__ == "__main__":
    main()
