import logging
from telegram import (
    Update,
    ReplyKeyboardMarkup,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters
)

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================

BOT_TOKEN = "PASTE_BOT_TOKEN_HERE"
CHANNEL_ID = -1001234567890

FULL_ADMINS = [111111111]
DEFAULT_ADMINS = [222222222]

BANNED_USERS = set()
WAITING_MESSAGE = set()

# ================= –ö–ù–û–ü–ö–ò =================

main_keyboard = ReplyKeyboardMarkup(
    [["‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

def moderation_keyboard(user_id):
    return InlineKeyboardMarkup([
        [
            InlineKeyboardButton("‚úÖ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨", callback_data=f"publish:{user_id}"),
            InlineKeyboardButton("üî¥ –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨", callback_data="ignore")
        ],
        [
            InlineKeyboardButton("üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨", callback_data=f"ban:{user_id}")
        ]
    ])

# ================= /start =================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏ –Ω–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ üëá",
        reply_markup=main_keyboard
    )

# ================= –ö–ù–û–ü–ö–ò =================

async def buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text

    if text == "‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ":
        WAITING_MESSAGE.add(update.effective_user.id)
        await update.message.reply_text("‚úèÔ∏è –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ")

    elif text == "‚ÑπÔ∏è –û –±–æ—Ç–µ":
        await update.message.reply_text("–ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π")

# ================= –û–ë–†–ê–ë–û–¢–ö–ê –°–û–û–ë–©–ï–ù–ò–ô =================

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user

    if user.id in BANNED_USERS:
        return

    if user.id not in WAITING_MESSAGE:
        return

    WAITING_MESSAGE.discard(user.id)

    msg = update.message

    # ---------- –¢–ï–ö–°–¢ ----------
    if msg.text:
        content = msg.text
        send_method = "text"

    # ---------- –§–û–¢–û ----------
    elif msg.photo:
        content = msg.photo[-1].file_id
        send_method = "photo"

    # ---------- –í–ò–î–ï–û ----------
    elif msg.video:
        content = msg.video.file_id
        send_method = "video"

    # ---------- –ì–û–õ–û–° ----------
    elif msg.voice:
        content = msg.voice.file_id
        send_method = "voice"

    # ---------- –ö–†–£–ñ–û–ö ----------
    elif msg.video_note:
        content = msg.video_note.file_id
        send_method = "video_note"

    else:
        await msg.reply_text("‚ùå –≠—Ç–æ—Ç —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è")
        return

    # ====== DEFAULT –ê–î–ú–ò–ù–´ ======
    for admin_id in DEFAULT_ADMINS:
        text_header = (
            "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
            "@anonymousaskkbot"
        )

        if send_method == "text":
            await context.bot.send_message(
                admin_id,
                f"{text_header}\n\n{content}",
                reply_markup=moderation_keyboard(user.id)
            )
        else:
            await getattr(context.bot, f"send_{send_method}")(
                admin_id,
                content,
                caption=text_header,
                reply_markup=moderation_keyboard(user.id)
            )

    # ====== FULL –ê–î–ú–ò–ù–´ ======
    username = f"@{user.username}" if user.username else "–Ω–µ—Ç"

    admin_info = (
        f"–ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
        f"üë§ {user.first_name}\n"
        f"üîó {username}\n"
        f"üÜî {user.id}"
    )

    for admin_id in FULL_ADMINS:
        if send_method == "text":
            await context.bot.send_message(admin_id, f"{admin_info}\n\n{content}")
        else:
            await getattr(context.bot, f"send_{send_method}")(
                admin_id,
                content,
                caption=admin_info
            )

    await msg.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", reply_markup=main_keyboard)

# ================= CALLBACK –ö–ù–û–ü–ö–ò =================

async def callbacks(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    action, *data = query.data.split(":")

    if action == "publish":
        user_id = int(data[0])

        await context.bot.copy_message(
            chat_id=CHANNEL_ID,
            from_chat_id=query.message.chat_id,
            message_id=query.message.message_id
        )

        await query.edit_message_reply_markup()

    elif action == "ignore":
        await query.edit_message_reply_markup()

    elif action == "ban":
        user_id = int(data[0])
        BANNED_USERS.add(user_id)
        await query.edit_message_reply_markup()

# ================= MAIN =================

def main():
    logging.basicConfig(level=logging.INFO)

    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(callbacks))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, buttons))
    app.add_handler(MessageHandler(filters.ALL, handle_message))

    app.run_polling()

if __name__ == "__main__":
    main()
