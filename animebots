import os
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

BOT_TOKEN = os.environ.get("BOT_TOKEN")

# –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é: 123,456,789
ADMIN_IDS = list(map(int, os.environ.get("ADMIN_IDS").split(",")))

# –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
LAST_MESSAGE = {}
BANNED_USERS = set()

# ---------- –ö–ù–û–ü–ö–ò ----------
main_keyboard = ReplyKeyboardMarkup(
    [["‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

admin_keyboard = ReplyKeyboardMarkup(
    [["üì© –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"]],
    resize_keyboard=True
)

# ---------- /start ----------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    await update.message.reply_text(
        "üëã –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É.",
        reply_markup=main_keyboard
    )

# ---------- –û –ë–û–¢–ï ----------
async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ü§ñ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏.\n"
        "–°–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã."
    )

# ---------- –°–û–û–ë–©–ï–ù–ò–Ø ----------
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = update.message.text

    # –õ–æ–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ Railway
    print(f"[LOG] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user.id} ({user.first_name}): {text}")

    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞ (/start, /admin) ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if text.startswith("/"):
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω
    if user.id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    # –ö–Ω–æ–ø–∫–∞ "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
    if "–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ" in text:
        await update.message.reply_text("‚úçÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–¥–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º.")
        return

    # –ö–Ω–æ–ø–∫–∞ "–û –±–æ—Ç–µ"
    if "–û –±–æ—Ç–µ" in text:
        await about(update, context)
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω—É
    global LAST_MESSAGE
    LAST_MESSAGE = {
        "name": user.first_name,
        "username": f"@{user.username}" if user.username else "–Ω–µ—Ç",
        "id": user.id,
        "text": text
    }

    admin_text = (
        "üì© –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n"
        f"üë§ –ò–º—è: {LAST_MESSAGE['name']}\n"
        f"üîó Username: {LAST_MESSAGE['username']}\n"
        f"üÜî ID: {LAST_MESSAGE['id']}\n\n"
        f"üí¨ –¢–µ–∫—Å—Ç:\n{LAST_MESSAGE['text']}"
    )

    for admin_id in ADMIN_IDS:
        await context.bot.send_message(chat_id=admin_id, text=admin_text)

    # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.", reply_markup=main_keyboard)
# ---------- –ê–î–ú–ò–ù ----------
def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

async def admin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return

    await update.message.reply_text("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=admin_keyboard)

async def last_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return

    if not LAST_MESSAGE:
        await update.message.reply_text("‚ùå –°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç.")
        return

    text = (
        "üì® –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n\n"
        f"üë§ –ò–º—è: {LAST_MESSAGE['name']}\n"
        f"üîó Username: {LAST_MESSAGE['username']}\n"
        f"üÜî ID: {LAST_MESSAGE['id']}\n\n"
        f"üí¨ –¢–µ–∫—Å—Ç:\n{LAST_MESSAGE['text']}"
    )

    await update.message.reply_text(text)

# ---------- –ë–ê–ù ----------
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return

    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id>")
        return

    try:
        uid = int(context.args[0])
        BANNED_USERS.add(uid)
        await update.message
reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_admin(update.effective_user.id):
        return

    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>")
        return

    try:
        uid = int(context.args[0])
        BANNED_USERS.discard(uid)
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

# ---------- –ó–ê–ü–£–°–ö ----------
def main():
    app = ApplicationBuilder().token("8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA").build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("admin", admin))
    app.add_handler(CommandHandler("ban", ban))
    app.add_handler(CommandHandler("unban", unban))
    app.add_handler(MessageHandler(filters.Regex("^üì© –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ$"), last_message))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
