import logging
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove
)
from telegram.ext import (
    ApplicationBuilder,
    ContextTypes,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    filters
)

# ================= –ù–ê–°–¢–†–û–ô–ö–ò =================
BOT_TOKEN = "8542679681:AAE8iNRt23pFoSYqOESvhD44Vq4jnnpQkYA"

FULL_ADMINS = [8066689541,1157418027]       # —Ñ—É–ª–ª –∞–¥–º–∏–Ω—ã
DEFAULT_ADMINS = [916852840,7729231060]    # –¥–µ—Ñ–æ–ª—Ç –∞–¥–º–∏–Ω—ã
CHANNEL_ID = "-1002273765519"

# ================= –õ–û–ì–ò =================
logging.basicConfig(level=logging.INFO)

# ================= –•–†–ê–ù–ò–õ–ò–©–ê =================
WAITING_USERS = set()
BANNED_USERS = set()
PENDING_MESSAGES = {}

# ================= –ö–ù–û–ü–ö–ò =================
main_keyboard = ReplyKeyboardMarkup(
    [["‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]],
    resize_keyboard=True
)

# ================= /start =================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –û—Ç–ø—Ä–∞–≤—å –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ üëá",
        reply_markup=main_keyboard
    )

# ================= –ù–ê–ü–ò–°–ê–¢–¨ =================
async def write_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    WAITING_USERS.add(update.effective_user.id)
    await update.message.reply_text(
        "‚úçÔ∏è –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å –º–µ–¥–∏–∞",
        reply_markup=ReplyKeyboardRemove()
    )

# ================= –û –ë–û–¢–ï =================
async def about_bot(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text(
        "ü§ñ –ê–Ω–æ–Ω–∏–º–Ω—ã–π –±–æ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π",
        reply_markup=main_keyboard
    )

# ================= –ë–ê–ù =================
async def ban_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id not in FULL_ADMINS:
        return
    uid = int(context.args[0])
    BANNED_USERS.add(uid)
    await update.message.reply_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω")

# ================= –°–û–û–ë–©–ï–ù–ò–Ø =================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    msg = update.message

    if user.id in BANNED_USERS or user.id not in WAITING_USERS:
        return

    WAITING_USERS.remove(user.id)

    text = msg.text or ""
    media = None
    media_type = None

    if msg.photo:
        media = msg.photo[-1].file_id
        media_type = "photo"
    elif msg.video:
        media = msg.video.file_id
        media_type = "video"

    final_caption = (
        "–£ —Ç–µ–±—è –Ω–æ–≤–æ–µ –∞–Ω–æ–Ω–∏–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!\n\n"
        f"{text}\n\n"
        "@anonymousaskkbot"
    )

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨", callback_data="publish")],
        [InlineKeyboardButton("üî¥ –ò–ì–ù–û–†–ò–†–û–í–ê–¢–¨", callback_data="ignore")],
        [InlineKeyboardButton("üö´ –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–¢–¨", callback_data=f"ban:{user.id}")]
    ])

    for admin_id in DEFAULT_ADMINS:
        PENDING_MESSAGES[admin_id] = {
            "caption": final_caption,
            "media": media,
            "media_type": media_type,
            "user_id": user.id
        }

        if media_type == "photo":
            await context.bot.send_photo(admin_id, media, caption=final_caption, reply_markup=keyboard)
        elif media_type == "video":
            await context.bot.send_video(admin_id, media, caption=final_caption, reply_markup=keyboard)
        else:
            await context.bot.send_message(admin_id, final_caption, reply_markup=keyboard)

    await msg.reply_text("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", reply_markup=main_keyboard)

# ================= –ö–ù–û–ü–ö–ò =================
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    admin_id = query.from_user.id
    data = PENDING_MESSAGES.get(admin_id)
    if not data:
        await query.edit_message_text("‚ùå –£—Å—Ç–∞—Ä–µ–ª–æ")
        return

    caption = data["caption"]
    media = data["media"]
    media_type = data["media_type"]

    if query.data == "publish":
        if media_type == "photo":
            await context.bot.send_photo(CHANNEL_ID, media, caption=caption)
        elif media_type == "video":
            await context.bot.send_video(CHANNEL_ID, media, caption=caption)
        else:
            await context.bot.send_message(CHANNEL_ID, caption)

        await query.edit_message_text("‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ")

    elif query.data == "ignore":
        await query.edit_message_text("üî¥ –ü—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–æ")

    elif query.data.startswith("ban"):
        uid = int(query.data.split(":")[1])
        BANNED_USERS.add(uid)
        await query.edit_message_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–∞–Ω–µ–Ω")

    PENDING_MESSAGES.pop(admin_id, None)

# ================= –ó–ê–ü–£–°–ö =================
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("ban", ban_user))
    app.add_handler(MessageHandler(filters.Regex("^‚úçÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ$"), write_message))
    app.add_handler(MessageHandler(filters.Regex("^‚ÑπÔ∏è –û –±–æ—Ç–µ$"), about_bot))
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))
    app.add_handler(CallbackQueryHandler(button_handler))

    app.run_polling()

if __name__ == "__main__":
    main()
