import os
from datetime import datetime
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters
)

# =========================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# =========================
BOT_TOKEN = os.environ.get("BOT_TOKEN")  # –í–∞—à —Ç–æ–∫–µ–Ω
FULL_ADMINS = list(map(int, os.environ.get("FULL_ADMINS", "0").split(",")))
DEFAULT_ADMINS = list(map(int, os.environ.get("DEFAULT_ADMINS", "0").split(",")))
MESSAGE_LIMIT = 5

LAST_MESSAGE = {}
BANNED_USERS = set()
USER_COUNTER = {}  # {user_id: {"count": int, "date": datetime}}

# =========================
# –ö–Ω–æ–ø–∫–∏
# =========================
main_keyboard = ReplyKeyboardMarkup([["‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"], ["‚ÑπÔ∏è –û –±–æ—Ç–µ"]], resize_keyboard=True)

# =========================
# /start
# =========================
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return
    await update.message.reply_text("üëã –ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É.", reply_markup=main_keyboard)

# =========================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
# =========================
def check_limit(user_id):
    now = datetime.now()
    data = USER_COUNTER.get(user_id)
    if not data or data["date"].date() != now.date():
        USER_COUNTER[user_id] = {"count": 0, "date": now}
    return USER_COUNTER[user_id]["count"] < MESSAGE_LIMIT

def increment_count(user_id):
    USER_COUNTER[user_id]["count"] += 1

# =========================
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞
# =========================
def is_full_admin(user_id): return user_id in FULL_ADMINS
def is_default_admin(user_id): return user_id in DEFAULT_ADMINS

# =========================
# –§–æ—Ä–º–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è Full Admin
# =========================
def make_admin_caption(user, message_text, media_type=""):
    phone = getattr(user, 'phone_number', "–Ω–µ—Ç")
    media_label = f"\nüí¨ –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: {media_type}" if media_type else ""
    return (
        f"üì© –ü—Ä–∏—à–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç:\n"
        f"üë§ –ò–º—è: {user.first_name}\n"
        f"üîó Username: @{user.username if user.username else '–Ω–µ—Ç'}\n"
        f"üÜî ID: {user.id}\n"
        f"üìû –ù–æ–º–µ—Ä: {phone}{media_label}\n\n"
        f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:\n\"{message_text}\""
    )

# =========================
# –§–æ—Ä–º–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è Default Admin
# =========================
def make_default_caption(message_text, media_type=""):
    media_label = f"\nüí¨ –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: {media_type}" if media_type else ""
    return f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:\n\"{message_text}\"{media_label}"

# =========================
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤
# =========================
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    user_id = user.id

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∞
    if user_id in BANNED_USERS:
        await update.message.reply_text("üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
        return

    # –õ–∏–º–∏—Ç
    if not check_limit(user_id):
        await update.message.reply_text(f"‚ö†Ô∏è –õ–∏–º–∏—Ç {MESSAGE_LIMIT} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.")
        return
    increment_count(user_id)

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –º–µ–¥–∏–∞
    user_message_text = update.message.text if update.message.text else "[–ù–µ —Ç–µ–∫—Å—Ç]"
    media_type = ""
    media_file_id = None

    if update.message.photo:
        media_type = "–§–æ—Ç–æ"
        media_file_id = update.message.photo[-1].file_id
    elif update.message.video:
        media_type = "–í–∏–¥–µ–æ"
        media_file_id = update.message.video.file_id
    elif update.message.audio:
        media_type = "–ê—É–¥–∏–æ"
        media_file_id = update.message.audio.file_id
    elif update.message.voice:
        media_type = "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"
        media_file_id = update.message.voice.file_id
    elif update.message.document:
        media_type = "–î–æ–∫—É–º–µ–Ω—Ç"
        media_file_id = update.message.document.file_id

    # --- Full Admin ---
    for admin_id in FULL_ADMINS:
        caption = make_admin_caption(user, user_message_text, media_type)
        try:
            if media_file_id:
                if media_type == "–§–æ—Ç–æ":
                    await context.bot.send_photo(chat_id=admin_id, photo=media_file_id, caption=caption)
                elif media_type == "–í–∏–¥–µ–æ":
                    await context.bot.send_video(chat_id=admin_id, video=media_file_id, caption=caption)
                elif media_type == "–ê—É–¥–∏–æ":
                    await context.bot.send_audio(chat_id=admin_id, audio=media_file_id, caption=caption)
                elif media_type == "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ":
                    await context.bot.send_voice(chat_id=admin_id, voice=media_file_id, caption=caption)
                elif media_type == "–î–æ–∫—É–º–µ–Ω—Ç":
                    await context.bot.send_document(chat_id=admin_id, document=media_file_id, caption=caption)
            else:
                await context.bot.send_message(chat_id=admin_id, text=caption)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Full Admin: {e}")

    # --- Default Admin ---
    for admin_id in DEFAULT_ADMINS:
        caption = make_default_caption(user_message_text, media_type)
        try:
            if media_file_id:
                if media_type == "–§–æ—Ç–æ":
                    await context.bot.send_photo(chat_id=admin_id, photo=media_file_id, caption=caption)
                elif media_type == "–í–∏–¥–µ–æ":
                    await context.bot.send_video(chat_id=admin_id, video=media_file_id, caption=caption)
                elif media_type == "–ê—É–¥–∏–æ":
                    await context.bot.send_audio(chat_id=admin_id, audio=media_file_id, caption=caption)
                elif media_type == "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ":
                    await context.bot.send_voice(chat_id=admin_id, voice=media_file_id, caption=caption)
                elif media_type == "–î–æ–∫—É–º–µ–Ω—Ç":
                    await context.bot.send_document(chat_id=admin_id, document=media_file_id, caption=caption)
            else:
                await context.bot.send_message(chat_id=admin_id, text=caption)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ Default Admin: {e}")

    # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await update.message.reply_text("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.", reply_markup=main_keyboard)

# =========================
# –°–∫—Ä—ã—Ç—ã–µ –∞–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã
# =========================
async def ban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_full_admin(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id>")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.add(uid)
        await update.message.reply_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

async def unban(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not is_full_admin(update.effective_user.id):
        return
    if not context.args:
        await update.message.reply_text("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>")
        return
    try:
        uid = int(context.args[0])
        BANNED_USERS.discard(uid)
        await update.message.reply_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω.")
    except:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID")

# =========================
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# =========================
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    # –ö–æ–º–∞–Ω–¥—ã
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("ban", ban))
    app.add_handler(CommandHandler("unban", unban))

    # –°–æ–æ–±—â–µ–Ω–∏—è –ª—é–±—ã—Ö —Ç–∏–ø–æ–≤
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))

    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling()

if __name__ == "__main__":
    main()
